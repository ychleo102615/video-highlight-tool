# Feature Specification: 會話清理與刪除

**Feature Branch**: `006-session-cleanup`
**Created**: 2025-11-04
**Status**: Draft
**Input**: User description: "新增「刪除存檔」的 useCase。在網頁 header 新增「刪除高光紀錄」按鈕,刪除該會話的持久化紀錄。在按鈕 UI 旁邊補充小字說明過時資料自動刪除機制。"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 手動刪除當前會話資料 (Priority: P1)

使用者在編輯視頻高光時,希望能夠手動刪除當前分頁會話的所有資料(包括上傳的視頻、轉錄內容、編輯進度等),以便重新開始或釋放儲存空間。

**Why this priority**: 這是核心功能,允許使用者主動管理自己的資料,是資料主權的基本體現。沒有這個功能,使用者無法清理不需要的會話資料。

**Independent Test**: 可以透過上傳視頻、進行編輯後,點擊刪除按鈕,驗證當前會話的所有資料是否被清除,並能重新上傳視頻建立新會話。

**Acceptance Scenarios**:

1. **Given** 使用者已上傳視頻並有編輯進度, **When** 點擊 header 的「刪除高光紀錄」按鈕並確認刪除, **Then** 系統清除當前 sessionId 的所有持久化資料(IndexedDB 中的 videos/transcripts/highlights),並清除 sessionStorage,返回初始狀態(可上傳新視頻)
2. **Given** 使用者已上傳視頻, **When** 點擊刪除按鈕但取消確認對話框, **Then** 系統保留所有資料,使用者可繼續編輯
3. **Given** 使用者剛完成刪除操作, **When** 重新整理頁面, **Then** 系統顯示初始上傳介面,沒有任何之前的會話資料

---

### User Story 2 - 了解自動清理機制 (Priority: P2)

使用者在查看刪除功能時,可以透過 UI 上的說明文字,了解系統的自動清理機制(BrowserStorage 會在應用啟動時清理超過 24 小時的過期資料)。

**Why this priority**: 這是次要功能,提供透明度和使用者教育,幫助使用者理解資料生命週期,減少對資料遺失的疑慮。

**Independent Test**: 可以透過檢視刪除按鈕旁的說明文字,驗證是否清楚傳達自動清理政策。

**Acceptance Scenarios**:

1. **Given** 使用者查看應用程式 header, **When** 注意到刪除按鈕旁的小字說明, **Then** 使用者能理解系統會在應用啟動時自動清理超過 24 小時未使用的會話資料
2. **Given** 說明文字顯示自動清理規則, **When** 使用者閱讀後, **Then** 使用者知道資料會保留 24 小時,之後會在下次應用啟動時被自動清除

---

### User Story 3 - 刪除前的安全確認 (Priority: P1)

使用者在點擊刪除按鈕時,系統會顯示確認對話框,列出將要刪除的資料範圍,避免誤刪重要內容。

**Why this priority**: 這是關鍵的使用者保護機制,防止意外資料遺失,特別是當使用者投入大量時間編輯時。

**Independent Test**: 可以透過點擊刪除按鈕,驗證確認對話框是否出現,以及取消/確認流程是否正確。

**Acceptance Scenarios**:

1. **Given** 使用者點擊刪除按鈕, **When** 確認對話框出現, **Then** 對話框清楚說明將刪除當前會話的資料類型(視頻檔案、轉錄內容、編輯紀錄等)
2. **Given** 確認對話框顯示中, **When** 使用者點擊「取消」, **Then** 對話框關閉,沒有任何資料被刪除
3. **Given** 確認對話框顯示中, **When** 使用者點擊「確認刪除」, **Then** 系統執行刪除並提供回饋訊息

---

### Edge Cases

- **刪除過程中錯誤處理**: 如果刪除 IndexedDB 資料時發生錯誤(例如權限問題),系統應該捕捉錯誤,顯示友善訊息,並盡可能完成部分清理(如清除 sessionStorage)
- **多分頁隔離**: 如果使用者在多個瀏覽器分頁開啟應用,每個分頁有獨立的 sessionId,在其中一個分頁刪除資料不應影響其他分頁的會話
- **刪除按鈕的顯示時機**: 在沒有會話資料時(初始狀態),刪除按鈕應該被禁用或隱藏
- **刪除後的狀態重置**: 刪除操作應該徹底清理 Pinia stores 的狀態,確保下次上傳視頻時不會有殘留資料

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統必須在應用程式 header 顯示「刪除高光紀錄」按鈕
- **FR-002**: 系統必須在刪除按鈕旁顯示小字說明:「系統會在應用啟動時自動清理超過 24 小時的會話資料」
- **FR-003**: 使用者必須能夠透過點擊刪除按鈕來刪除當前會話(當前 sessionId)的所有持久化資料
- **FR-004**: 系統必須在執行刪除前顯示確認對話框,列出將要刪除的資料範圍
- **FR-005**: 系統必須提供「確認」和「取消」選項在確認對話框中
- **FR-006**: 系統必須刪除當前 sessionId 的以下資料:IndexedDB 中的 videos/transcripts/highlights 記錄
- **FR-007**: 系統必須在刪除完成後清除 sessionStorage 中的 sessionId
- **FR-008**: 系統必須在刪除完成後將應用程式狀態重置為初始狀態(清空所有 Pinia stores,顯示上傳介面)
- **FR-009**: 系統必須在刪除失敗時顯示錯誤訊息,並保留原有資料不變
- **FR-010**: 當沒有活躍會話時(無 sessionId 或無資料),刪除按鈕必須被禁用
- **FR-011**: 刪除操作必須只影響當前分頁的會話,不影響其他分頁或其他會話的資料

### Key Entities

- **Session**: 代表一個瀏覽器分頁的編輯會話,由 sessionId 唯一識別,包含該會話的所有視頻、轉錄、高光資料
- **SessionMetadata**: 會話的中繼資料,包含 sessionId、建立時間(savedAt)等資訊,用於自動清理判斷

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 使用者能在 3 秒內完成刪除操作(從點擊按鈕到確認完成)
- **SC-002**: 刪除操作成功率達 99% 以上(排除瀏覽器儲存空間異常等外部因素)
- **SC-003**: 100% 的使用者在閱讀說明文字後能理解自動清理機制(透過使用者測試驗證)
- **SC-004**: 刪除後系統狀態完全重置,使用者可立即上傳新視頻並開始新會話
- **SC-005**: 誤刪率低於 5%(透過確認對話框有效防止意外刪除)
- **SC-006**: 刪除按鈕的可見性和可用性符合使用者預期(在有會話時可見可用,無會話時禁用)
- **SC-007**: 多分頁場景下,刪除操作正確隔離,不影響其他分頁(100% 隔離率)

## Assumptions

1. **自動清理機制**: BrowserStorage.cleanupStaleData() 已實作 24 小時自動清理功能,在應用啟動時執行
2. **會話隔離模型**: 每個瀏覽器分頁有獨立的 sessionId(儲存在 sessionStorage),會話資料在 IndexedDB 中按 sessionId 隔離
3. **不限制會話數量**: 系統支援多個會話並存,不同分頁或不同時間的會話彼此獨立
4. **瀏覽器支援**: 假設使用者的瀏覽器支援 IndexedDB 和 SessionStorage
5. **本地刪除**: 刪除操作完全在本地執行,不需要網路連線
6. **即時刪除**: 刪除操作是同步的,IndexedDB 的刪除操作立即執行
