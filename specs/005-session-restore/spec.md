# Feature Specification: 會話恢復 (Session Restore)

**Feature Branch**: `005-session-restore`
**Created**: 2025-11-02
**Status**: Draft
**Input**: User description: "建立 RestoreSessionUseCase 來處理應用啟動時的會話恢復：(1) 在 BrowserStorage 新增 restoreAllVideos() 等批量查詢方法；(2) 修改三個 Repository 的 findAll()/findByVideoId() 方法，在記憶體 Map 為空時自動從 BrowserStorage 恢復資料；(3) 建立 RestoreSessionUseCase，協調 Video/Transcript/Highlight 三個 Repository 查詢，判斷是否需要重新上傳（大視頻 file 為 null），返回 SessionStateDTO { video, transcript, highlights, needsReupload }；(4) 在 DI Container 註冊 Use Case；(5) 在 videoStore 新增 restoreSession() action 調用 Use Case，根據 needsReupload 決定顯示提示訊息或完整恢復狀態；(6) 在 App.vue onMounted 調用 videoStore.restoreSession()，實現刷新後自動恢復編輯狀態（小視頻完整恢復，大視頻提示重新上傳但保留編輯內容）。"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 小視頻完整恢復 (Priority: P1)

當使用者在編輯小於儲存閾值的視頻時意外刷新頁面（如誤按 F5、關閉分頁後重開），應用應該自動恢復先前的編輯狀態，包含視頻檔案、轉錄文字和高光片段選擇，讓使用者無需重新上傳視頻即可繼續編輯。

**Why this priority**: 這是最常見且影響最大的使用情境。小視頻完整恢復能提供最佳使用者體驗，避免使用者因意外刷新而失去編輯進度，是會話恢復功能的核心價值。

**Independent Test**: 可以透過「上傳小視頻（例如 20MB）→ 選擇高光片段 → 刷新頁面 → 確認狀態完整恢復」的完整流程獨立測試，並驗證視頻播放、轉錄文字和高光選擇都正確恢復。

**Acceptance Scenarios**:

1. **Given** 使用者已上傳一個 20MB 的視頻並選擇了 3 個高光片段，**When** 使用者按下 F5 刷新頁面，**Then** 頁面重新載入後自動恢復視頻、轉錄文字和 3 個高光片段的選擇狀態，使用者可以直接繼續編輯
2. **Given** 使用者正在預覽高光視頻（播放到第 30 秒），**When** 使用者不小心關閉分頁後重新開啟應用，**Then** 視頻恢復到初始狀態（第 0 秒），但所有編輯內容（轉錄文字、高光選擇）都被保留
3. **Given** 使用者已完成編輯並準備匯出，**When** 使用者刷新頁面，**Then** 系統恢復所有狀態，使用者可以立即進行匯出操作而無需重新編輯

---

### User Story 2 - 大視頻編輯內容保留 (Priority: P2)

當使用者在編輯超過儲存閾值的視頻時刷新頁面，由於視頻檔案未儲存在 IndexedDB，應用應該保留使用者的編輯內容（轉錄文字、高光選擇），並顯示友善的提示訊息，引導使用者重新上傳相同的視頻檔案以繼續編輯。

**Why this priority**: 雖然需要使用者重新上傳視頻，但保留編輯內容能避免使用者重做標記工作，仍然提供相當大的價值。這是針對大視頻檔案的合理折衷方案。

**Independent Test**: 可以透過「上傳大視頻（例如 100MB）→ 選擇高光片段 → 刷新頁面 → 確認顯示提示訊息 → 重新上傳視頻 → 確認編輯內容恢復」的流程獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者已上傳一個 100MB 的視頻並選擇了 5 個高光片段，**When** 使用者刷新頁面，**Then** 系統顯示「偵測到先前的編輯內容，請重新上傳視頻以繼續編輯」的提示訊息，並保留轉錄文字和高光片段資訊
2. **Given** 使用者看到「請重新上傳視頻」的提示訊息，**When** 使用者重新上傳相同的視頻檔案，**Then** 系統自動恢復先前的所有編輯內容（轉錄文字、高光選擇），使用者可以繼續編輯
3. **Given** 使用者看到「請重新上傳視頻」的提示訊息，**When** 使用者選擇上傳不同的視頻檔案，**Then** 系統清除先前的編輯內容，使用 AI 處理新視頻並產生新的轉錄文字和高光建議

---

### User Story 3 - 首次訪問無恢復狀態 (Priority: P3)

當使用者首次訪問應用或清除瀏覽器資料後訪問，系統應該正常顯示初始的上傳介面，不顯示任何錯誤訊息或不必要的提示。

**Why this priority**: 這是基本的錯誤處理情境，確保在沒有會話資料時應用能正常運作。雖然重要，但因為是預設行為，優先級相對較低。

**Independent Test**: 可以透過「清除瀏覽器資料 → 訪問應用 → 確認顯示正常的上傳介面」獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者首次訪問應用（瀏覽器無任何儲存資料），**When** 應用載入完成，**Then** 系統顯示正常的視頻上傳介面，不顯示任何恢復相關的提示訊息
2. **Given** 使用者清除了瀏覽器的 IndexedDB 和 SessionStorage 資料，**When** 使用者重新訪問應用，**Then** 系統正常啟動，顯示上傳介面，不出現任何錯誤
3. **Given** 使用者在無痕模式下開啟應用，**When** 應用載入完成，**Then** 系統正常顯示上傳介面，功能運作正常

---

### User Story 4 - 會話過期處理 (Priority: P3)

當使用者長時間（超過 24 小時）未訪問應用後重新開啟，系統應該檢測到會話資料可能已過期，清除舊資料並顯示全新的上傳介面，避免使用者看到過時的編輯內容。

**Why this priority**: 這是邊緣情境的優雅處理，避免混淆使用者。但因為發生頻率較低，且不影響核心功能，優先級最低。

**Independent Test**: 可以透過「上傳視頻 → 編輯內容 → 等待 24 小時以上 → 重新訪問應用 → 確認顯示全新介面」獨立測試（可透過手動修改儲存資料的時間戳來模擬）。

**Acceptance Scenarios**:

1. **Given** 使用者在 48 小時前上傳並編輯了一個視頻，**When** 使用者重新訪問應用，**Then** 系統清除過期的會話資料，顯示全新的上傳介面
2. **Given** 使用者在 30 分鐘前編輯視頻，**When** 使用者重新訪問應用，**Then** 系統正常恢復會話狀態（因為未超過 24 小時）
3. **Given** 使用者的會話資料因過期被清除，**When** 使用者上傳新視頻，**Then** 系統正常處理新視頻，不受舊資料影響

---

### Edge Cases

- **資料不完整**: 如果 IndexedDB 中只有 Video 資料但缺少 Transcript 或 Highlight 資料，系統應該顯示錯誤訊息並要求重新上傳，避免部分恢復導致的不一致狀態。
- **資料版本不相容**: 如果應用更新後，舊的儲存資料結構與新版本不相容，系統應該清除舊資料並顯示提示訊息，引導使用者重新開始。
- **多個視頻會話**: 目前假設使用者每次只編輯一個視頻。如果未來支援多個視頻專案，需要決定恢復哪一個（預設恢復最後編輯的專案）。
- **儲存空間不足**: 當 IndexedDB 儲存空間不足無法儲存視頻時，系統應該捕捉錯誤，將該視頻視為「大視頻」處理（file 為 null），在下次恢復時提示使用者重新上傳。
- **視頻檔案損壞**: 如果恢復的小視頻檔案在 IndexedDB 中已損壞無法播放，系統應該偵測到播放錯誤，顯示適當訊息，並提供清除資料或重新上傳的選項。
- **同時打開多個分頁**: 如果使用者同時在多個瀏覽器分頁中開啟應用，每個分頁應該獨立運作，但共享 IndexedDB 資料。最後儲存的分頁會覆蓋其他分頁的資料（預設行為，不需特殊處理）。
- **平台儲存限制差異**: 不同平台（桌面 vs 行動裝置）的 IndexedDB 儲存配額不同，系統應該根據平台動態決定儲存閾值，而非使用固定數值。

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統 MUST 在應用啟動時（App.vue onMounted）自動檢查瀏覽器儲存（IndexedDB 和 SessionStorage）中是否存在先前的會話資料
- **FR-002**: 系統 MUST 能夠從儲存中恢復完整的 Video、Transcript 和 Highlight 資料
- **FR-003**: 系統 MUST 能夠判斷視頻檔案是否可用（視頻 file 存在 vs. file 為 null）
- **FR-004**: 系統 MUST 根據使用者平台動態決定視頻檔案儲存閾值（例如：桌面預設 50MB，行動裝置可能更小）
- **FR-005**: 對於小於儲存閾值的視頻，系統 MUST 完整恢復視頻檔案、轉錄文字和高光選擇，使用者可以直接繼續編輯和預覽
- **FR-006**: 對於超過儲存閾值的視頻，系統 MUST 保留轉錄文字和高光選擇，但顯示友善的提示訊息，引導使用者重新上傳視頻檔案
- **FR-007**: 系統 MUST 在使用者重新上傳視頻後，自動恢復先前的編輯內容（轉錄文字、高光選擇）
- **FR-008**: 系統 MUST 在首次訪問或無會話資料時，正常顯示初始的上傳介面，不顯示錯誤或不必要的提示
- **FR-009**: 系統 MUST 能夠偵測並清除過期的會話資料（超過 24 小時未訪問）
- **FR-010**: 系統 MUST 在偵測到資料不完整或損壞時，顯示適當的錯誤訊息，並提供清除資料或重新開始的選項
- **FR-011**: 系統 MUST 維持應用狀態的一致性，確保編輯區和預覽區在恢復後正確同步

### Key Entities

- **Video**: 視頻實體，包含 id、file（可能為 null）、檔案名稱、時長等基本資訊
- **Transcript**: 轉錄文字實體，包含 videoId、段落（sections）和句子（sentences）結構，每個句子有時間戳（startTime, endTime）
- **Highlight**: 高光片段實體，包含 videoId、選中的句子 ID 清單（selectedSentenceIds）
- **SessionState**: 會話狀態 DTO，整合 Video、Transcript、Highlight 和 needsReupload 旗標，用於傳遞恢復結果

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 使用者在編輯小於儲存閾值的視頻時刷新頁面，95% 的情況下能在 2 秒內完整恢復編輯狀態（視頻、轉錄文字、高光選擇）
- **SC-002**: 使用者在編輯超過儲存閾值的視頻時刷新頁面，能正確保留編輯內容（轉錄文字、高光選擇），並在重新上傳視頻後於 1 秒內恢復編輯狀態
- **SC-003**: 使用者首次訪問或無會話資料時，100% 的情況下能正常顯示上傳介面，無錯誤訊息
- **SC-004**: 系統能正確處理至少 90% 的邊緣情境（資料不完整、損壞、過期等），不出現未預期的錯誤或崩潰
- **SC-005**: 會話恢復功能的加入不影響應用的正常啟動時間（增加不超過 500ms）
- **SC-006**: 系統能在至少 2 種不同平台（桌面、行動裝置）上正確判斷並應用適當的儲存閾值

## Assumptions

- 假設使用者的瀏覽器支援 IndexedDB 和 SessionStorage（現代瀏覽器的標準功能）
- 假設桌面平台的預設儲存閾值為 50MB（可根據實際 IndexedDB 配額動態調整）
- 假設行動裝置的儲存閾值可能更小（例如 20-30MB），需根據平台偵測結果決定
- 假設會話資料的過期時間為 24 小時（可在未來根據使用情況調整）
- 假設目前每次只編輯一個視頻專案（如果未來需要支援多專案，需要額外的專案管理機制）
- 假設視頻檔案的比對可以透過 videoId 進行（重新上傳的視頻會產生新的 videoId，需要使用者確認是否要恢復編輯內容）
- 假設編輯內容的恢復不需要保留播放進度（播放時間恢復到初始狀態）
- 假設儲存閾值的判斷邏輯已在 BrowserStorage 層實作，會話恢復功能僅需檢查 video.file 是否為 null
