import{o as n}from"./index-Dob3nYDb.js";import{D as c,a as l,S as o,M as d}from"./index-DYgSsspj.js";import{g as h}from"./id-generator-DvTcbe5n.js";class y{db;sessionId;async init(){try{this.sessionId=this.initSessionId(),this.db=await n(c,l,{upgrade(t){if(!t.objectStoreNames.contains("videos")){const e=t.createObjectStore("videos",{keyPath:"id"});e.createIndex("sessionId","sessionId",{unique:!1}),e.createIndex("savedAt","savedAt",{unique:!1})}if(!t.objectStoreNames.contains("transcripts")){const e=t.createObjectStore("transcripts",{keyPath:"id"});e.createIndex("videoId","videoId",{unique:!1}),e.createIndex("sessionId","sessionId",{unique:!1}),e.createIndex("savedAt","savedAt",{unique:!1})}if(!t.objectStoreNames.contains("highlights")){const e=t.createObjectStore("highlights",{keyPath:"id"});e.createIndex("videoId","videoId",{unique:!1}),e.createIndex("sessionId","sessionId",{unique:!1}),e.createIndex("savedAt","savedAt",{unique:!1})}}}),await this.cleanupStaleData()}catch(t){console.warn("Failed to initialize BrowserStorage:",t)}}initSessionId(){const t=sessionStorage.getItem(o);if(t)return t;const e=h();return sessionStorage.setItem(o,e),e}getSessionId(){return this.sessionId}async saveVideo(t){try{await this.db.put("videos",t)}catch(e){console.warn("Failed to save video:",e)}}async restoreVideo(t){try{return await this.db.get("videos",t)||null}catch(e){return console.warn("Failed to restore video:",e),null}}async restoreAllVideos(){try{return(await this.db.getAll("videos")).filter(e=>e.sessionId===this.sessionId)}catch(t){return console.warn("Failed to restore all videos:",t),[]}}async saveTranscript(t){try{await this.db.put("transcripts",t)}catch(e){console.warn("Failed to save transcript:",e)}}async restoreTranscript(t){try{return await this.db.get("transcripts",t)||null}catch(e){return console.warn("Failed to restore transcript:",e),null}}async restoreTranscriptByVideoId(t){try{const a=(await this.db.transaction("transcripts","readonly").store.index("videoId").getAll(t)).filter(i=>i.sessionId===this.sessionId);return a.length>0?a[0]:null}catch(e){return console.warn("Failed to restore transcript by videoId:",e),null}}async restoreAllTranscripts(){try{return await this.db.getAll("transcripts")}catch(t){return console.warn("Failed to restore all transcripts:",t),[]}}async saveHighlight(t){try{await this.db.put("highlights",t)}catch(e){console.warn("Failed to save highlight:",e)}}async restoreHighlight(t){try{return await this.db.get("highlights",t)||null}catch(e){return console.warn("Failed to restore highlight:",e),null}}async restoreHighlightsByVideoId(t){try{return(await this.db.transaction("highlights","readonly").store.index("videoId").getAll(t)).filter(a=>a.sessionId===this.sessionId)}catch(e){return console.warn("Failed to restore highlights by videoId:",e),[]}}async restoreAllHighlights(){try{return await this.db.getAll("highlights")}catch(t){return console.warn("Failed to restore all highlights:",t),[]}}async cleanupStaleData(){try{const t=Date.now();await this.cleanupStore("videos",t),await this.cleanupStore("transcripts",t),await this.cleanupStore("highlights",t)}catch(t){console.warn("Failed to cleanup stale data:",t)}}async cleanupStore(t,e){try{const r=this.db.transaction(t,"readwrite"),s=r.store,a=await s.getAll();for(const i of a)e-i.savedAt>d&&await s.delete(i.id);await r.done}catch(r){console.warn(`Failed to cleanup ${t}:`,r)}}async deleteSession(t){const e=["videos","transcripts","highlights"];for(const r of e)try{const s=this.db.transaction(r,"readwrite");let i=await s.store.index("sessionId").openCursor(t);for(;i;)await i.delete(),i=await i.continue();await s.done}catch(s){throw console.error(`Failed to delete ${r} for session ${t}:`,s),s}}}export{y as BrowserStorage};
