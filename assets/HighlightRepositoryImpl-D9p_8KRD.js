import"./index-Dob3nYDb.js";import{D as h}from"./dto-mapper-BfqElrW5.js";import"./Video-CZb525El.js";import"./Transcript-CIaTKO-4.js";import"./Highlight-wkXLIbi7.js";import"./VideoMetadata-CaYyTJPb.js";class f{constructor(i){this.browserStorage=i}highlights=new Map;async save(i){try{this.highlights.set(i.id,i);const t=this.browserStorage.getSessionId(),e=h.highlightEntityToPersistenceDto(i,t);await this.browserStorage.saveHighlight(e)}catch(t){console.warn("HighlightRepository: 儲存高光時發生錯誤",{highlightId:i.id,videoId:i.videoId,error:t instanceof Error?t.message:String(t)})}}async findById(i){try{const t=this.highlights.get(i);if(t)return t;const e=await this.browserStorage.restoreHighlight(i);if(!e)return null;const o=h.highlightPersistenceDtoToEntity(e);return this.highlights.set(i,o),o}catch(t){return console.warn("HighlightRepository: 查找高光時發生錯誤",{highlightId:i,error:t instanceof Error?t.message:String(t)}),null}}async findByVideoId(i){try{const t=[];for(const r of this.highlights.values())r.videoId===i&&t.push(r);const e=await this.browserStorage.restoreHighlightsByVideoId(i),o=[];for(const r of e)try{const s=h.highlightPersistenceDtoToEntity(r);this.highlights.has(s.id)||(this.highlights.set(s.id,s),o.push(s))}catch(s){console.warn("HighlightRepository: 轉換 DTO 時發生錯誤,跳過此筆資料",{highlightId:r.id,videoId:r.videoId,error:s instanceof Error?s.message:String(s)})}const g=new Map;for(const r of[...t,...o])g.set(r.id,r);return Array.from(g.values())}catch(t){return console.warn("HighlightRepository: 按視頻 ID 查找高光時發生錯誤",{videoId:i,error:t instanceof Error?t.message:String(t)}),[]}}async delete(i){this.highlights.delete(i)}async clear(){this.highlights.clear()}async findAll(){return Array.from(this.highlights.values())}}export{f as HighlightRepositoryImpl};
