import{V as n}from"./Video-CZb525El.js";import"./index-Dob3nYDb.js";import{D as i}from"./dto-mapper-BfqElrW5.js";import"./Transcript-CIaTKO-4.js";import"./Highlight-wkXLIbi7.js";import"./VideoMetadata-CaYyTJPb.js";class v{constructor(e,r){this.browserStorage=e,this.fileStorage=r}videos=new Map;async save(e){try{this.videos.set(e.id,e);const r=this.browserStorage.getSessionId(),s=i.videoEntityToPersistenceDto(e,r);await this.browserStorage.saveVideo(s)}catch(r){console.warn("VideoRepository: 儲存視頻時發生錯誤",{videoId:e.id,error:r instanceof Error?r.message:String(r)})}}async findById(e){try{const r=this.videos.get(e);if(r)return r;const s=await this.browserStorage.restoreVideo(e);if(!s)return null;let o=i.videoPersistenceDtoToEntity(s);try{const t=await this.fileStorage.save(o.file);o=new n(o.id,o.file,o.metadata,t)}catch(t){console.warn("VideoRepository: 無法重新創建 blob URL",{videoId:e,error:t instanceof Error?t.message:String(t)})}return this.videos.set(e,o),o}catch(r){return console.warn("VideoRepository: 查找視頻時發生錯誤",{videoId:e,error:r instanceof Error?r.message:String(r)}),null}}async delete(e){this.videos.delete(e)}async clear(){this.videos.clear()}async findAll(){try{if(this.videos.size>0)return Array.from(this.videos.values());const e=await this.browserStorage.restoreAllVideos(),r=[];for(const s of e){let o=i.videoPersistenceDtoToEntity(s);try{const t=await this.fileStorage.save(o.file);o=new n(o.id,o.file,o.metadata,t)}catch(t){console.warn("VideoRepository: 無法重新創建 blob URL",{videoId:o.id,error:t instanceof Error?t.message:String(t)})}this.videos.set(o.id,o),r.push(o)}return r}catch(e){return console.warn("VideoRepository: 查找所有視頻時發生錯誤",{error:e instanceof Error?e.message:String(e)}),[]}}}export{v as VideoRepositoryImpl};
